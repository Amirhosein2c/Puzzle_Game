<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Image Tile Puzzle – Physics Paper Mode</title>
    <style>
      body {
        margin: 0;
        background: #000;
        color: #eee;
        height: 100vh;
        overflow: hidden;
        font-family: Arial, sans-serif;
        user-select: none;
      }

      #hud {
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 24px;
        z-index: 1000;
      }

      #board {
        position: absolute;
        inset: 0;
        margin: auto;
        background: #111;
        touch-action: none;
      }

      .tile {
        position: absolute;
        background-repeat: no-repeat;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-sizing: border-box;
        cursor: grab;
        transition: left 0.3s cubic-bezier(0.22, 0.61, 0.36, 1),
          top 0.3s cubic-bezier(0.22, 0.61, 0.36, 1), box-shadow 0.3s ease;
      }

      .tile.dragging {
        transition: none;
        cursor: grabbing;
        z-index: 100;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
      }

      .tile.locked {
        border: none;
        cursor: default;
        box-shadow: none;
      }

      #message {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 28px;
        color: #4caf50;
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      #message.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div id="hud">
      <div>Time: <span id="time">0.0</span>s</div>
      <div>Moves: <span id="moves">0</span></div>
    </div>

    <div id="board"></div>
    <div id="message">You win!</div>

    <audio
      id="swapSound"
      src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="
    ></audio>
    <audio
      id="winSound"
      src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="
    ></audio>

    <script>
      /* ================= CONFIG ================= */
      const IMAGES = [
        "https://picsum.photos/900/900?random=11",
        "https://picsum.photos/900/900?random=12",
        "https://picsum.photos/900/900?random=13",
      ];
      const SIZE = 4;
      const PREVIEW_TIME = 3000;
      const NEXT_DELAY = 3000;

      /* ================= STATE ================= */
      const board = document.getElementById("board");
      const timeEl = document.getElementById("time");
      const movesEl = document.getElementById("moves");
      const message = document.getElementById("message");
      const swapSound = document.getElementById("swapSound");
      const winSound = document.getElementById("winSound");

      let tiles = [];
      let imageIndex = 0;
      let startTime = 0;
      let timer = null;
      let moves = 0;
      let zCounter = 1;

      /* ================= FULLSCREEN ================= */
      document.addEventListener(
        "pointerdown",
        () => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {});
          }
        },
        { once: true }
      );

      /* ================= GAME ================= */
      function startGame() {
        clearInterval(timer);
        board.innerHTML = "";
        tiles = [];
        moves = 0;
        zCounter = 1;
        movesEl.textContent = "0";
        message.classList.remove("show");

        const img = IMAGES[imageIndex++ % IMAGES.length];
        const boardSize = Math.min(innerWidth, innerHeight) * 0.7;
        const tileSize = boardSize / SIZE;

        board.style.width = boardSize + "px";
        board.style.height = boardSize + "px";
        board.style.left = "50%";
        board.style.top = "50%";
        board.style.transform = "translate(-50%, -50%)";

        for (let i = 0; i < SIZE * SIZE; i++) {
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.dataset.correct = i;
          tile.dataset.locked = "false";

          const col = i % SIZE;
          const row = Math.floor(i / SIZE);

          tile.style.width = tileSize + "px";
          tile.style.height = tileSize + "px";
          tile.style.left = col * tileSize + "px";
          tile.style.top = row * tileSize + "px";
          tile.style.backgroundImage = `url(${img})`;
          tile.style.backgroundSize = `${boardSize}px ${boardSize}px`;
          tile.style.backgroundPosition = `-${col * tileSize}px -${
            row * tileSize
          }px`;

          enablePaperPhysics(tile, tileSize);
          tiles.push(tile);
          board.appendChild(tile);
        }

        setTimeout(shuffleTiles, PREVIEW_TIME);
        startTimer();
      }

      function shuffleTiles() {
        tiles.forEach((tile) => {
          tile.style.left =
            Math.random() * (board.clientWidth - tile.clientWidth) + "px";
          tile.style.top =
            Math.random() * (board.clientHeight - tile.clientHeight) + "px";
          tile.style.zIndex = zCounter++;
        });
      }

      function startTimer() {
        startTime = performance.now();
        timer = setInterval(() => {
          timeEl.textContent = ((performance.now() - startTime) / 1000).toFixed(
            1
          );
        }, 100);
      }

      /* ================= PAPER PHYSICS ================= */
      function enablePaperPhysics(tile, tileSize) {
        let offsetX = 0,
          offsetY = 0;

        tile.addEventListener("pointerdown", (e) => {
          if (tile.dataset.locked === "true") return;
          tile.setPointerCapture(e.pointerId);
          tile.classList.add("dragging");
          tile.style.zIndex = zCounter++;
          offsetX = e.clientX - tile.offsetLeft;
          offsetY = e.clientY - tile.offsetTop;
        });

        tile.addEventListener("pointermove", (e) => {
          if (!tile.classList.contains("dragging")) return;
          tile.style.left = e.clientX - offsetX + "px";
          tile.style.top = e.clientY - offsetY + "px";
        });

        tile.addEventListener("pointerup", (e) => {
          tile.releasePointerCapture(e.pointerId);
          tile.classList.remove("dragging");
          handleDrop(tile, tileSize);
        });
      }

      function handleDrop(tile, tileSize) {
        const rect = tile.getBoundingClientRect();
        const boardRect = board.getBoundingClientRect();

        const col = Math.round((rect.left - boardRect.left) / tileSize);
        const row = Math.round((rect.top - boardRect.top) / tileSize);
        const targetIndex = row * SIZE + col;

        moves++;
        movesEl.textContent = moves;
        swapSound.currentTime = 0;
        swapSound.play();

        if (targetIndex === +tile.dataset.correct) {
          // Correct placement
          tile.style.left = col * tileSize + "px";
          tile.style.top = row * tileSize + "px";
          tile.classList.add("locked");
          tile.dataset.locked = "true";
          tile.style.zIndex = 0;
        } else {
          // Wrong placement → add random offset (paper feel)
          const jitter = tileSize * 0.05;
          tile.style.left =
            col * tileSize + (Math.random() * jitter - jitter / 2) + "px";
          tile.style.top =
            row * tileSize + (Math.random() * jitter - jitter / 2) + "px";
        }

        if (checkWin()) finishGame();
      }

      function checkWin() {
        return tiles.every((t) => t.dataset.locked === "true");
      }

      function finishGame() {
        clearInterval(timer);
        winSound.currentTime = 0;
        winSound.play();
        message.classList.add("show");
        setTimeout(startGame, NEXT_DELAY);
      }

      /* ================= START ================= */
      startGame();
    </script>
  </body>
</html>
